---
link-citations: yes
output:
  bookdown::html_document2:
    number_sections: false
    self_contained: false
    pandoc_args: "--mathjax"
    mathjax: NULL
    theme: NULL
    template: /home/liao/R/x86_64-pc-linux-gnu-library/3.4/rmarkdown/rmd/fragment/default.html
---
<!--For external images, set self_contained: false-->

<!--yaml
---
mermaid: false
mathjax: false
mathjax_autoNumber: false
highlight: true
title: 'Inserting “Edit on GitHub” Buttons in a Single R Markdown Document'
description: ""
tags: ['R', 'R Markdown', 'R-bloggers']
---
yaml-->


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	fig.dim = c(7, 4),
	message = FALSE,
	warning = FALSE,
	comment = "",
	#fig.path = "../../assets/",
	out.width = "100%"
)
library(knitr)
```

As the R Markdown ecosystem  becomes larger, users now may encounter situations where they have to make decisions on which output format of R Markdown to use. 
One may found **none of the formats suitable** -- the features essential to the output document you want may be scattered around (and only supported by) different output formats of R Markdown.

Here is a real example I encountered. I wanted to create a document that:

(@feat) supports [bookdown syntax](https://bookdown.org/yihui/bookdown/markdown-extensions-by-bookdown.html), e.g. text references.
(@feat) has an "Edit on GitHub" button for every chapter that links to the edit page of the source `.Rmd` on GitHub

The above two features can be easily obtained using bookdown's default GitBook output format, but one more feature is essential to the document I want:

(@feat) supports [tabsets](https://bookdown.org/yihui/rmarkdown/html-document.html#tabbed-sections)[^why]

So basically, I wanted `bookdown::gitbook` that supports tabbed sections, just like Fig. \@ref(fig:gitbook). No, it's not possible now. This is a feature unique to `rmarkdown::html_document`, [not `bookdown::gitbook`](https://github.com/rstudio/bookdown/issues/393).

```{r gitbook, fig.cap='`bookdown::gitbook` supports tabbed sections? This is just a fake figure.'}
include_graphics('/post_source/rmd_edit_btn/book_tabset.png')
```

My first thought was to find out how to add the tabbed sections feature to `bookdown::gitbook` using JavaScript, but I'm not familiar with JS and it just gave me a headache. So I turned to `bookdown::html_document2`, which is based on `rmarkdown::html_document`. 


## Adding `<i class="fa fa-edit"></i>` to Level One Headings

The [source of my document](https://github.com/liao961120/parallelCode) is a bookdown project, which has **several `.Rmd` files**.
Each `.Rmd` files starts with a level-one heading and defines a single chapter.
Setting `bookdown::html_document2` as the output format can only create a single document output (as opposed to `bookdown::gitbook` which creates several HTML files by default),
so if I want to add an "Edit on GitHub" button for every chapter, I have to track the **original `.Rmd` that generates the particular chapter**.

### "Merge and Knit" vs. "Knit and Merge"

There are [two rendering approaches](https://bookdown.org/yihui/bookdown/new-session.html) in bookdown. The default is **Merge and Knit**, which combines all source `.Rmd` files into one single `.Rmd` file and then knits the document. In this case, it will be impossible to track the source `.Rmd` file for each chapter (unless I create a lookup table manually).
I can track the source `.Rmd` files easily, however, if I render the document using the **Knit and Merge** approach. Using `knitr::current_input()`, I can retrieve the `.Rmd` file name while knitting the file, and this gives me all I need to create the link to the edit page of the `.Rmd` source file on GitHub.


### Setting up: `_bookdown.yml`

To switch from the default "Merge and Knit" to "Knit and Merge", set `new_session: yes` in `_bookdown.yml`:

```yaml
new_session: yes
before_chapter_script: 'addons/pre_chap.R'
```


### Setting up: `addons/pre_chap.R`

To insert the link to the edit page on GitHub from the `.Rmd` filename, I put <code>&#96;r edit_btn&#96;</code> (inline R code) at the end of the h1 heading of each `.Rmd` file, for [example](https://github.com/liao961120/parallelCode/blob/4ea55dba03feef91ecf12e1014000fedabcc184b/00-functional_programming.Rmd#L1):

```markdown
# Function Factories ``r paste0('r edit_btn')``
```

`edit_btn` is a string computed from the R script `addons/pre_chap.R`, which is run every time before knitting a `.Rmd` file:

```r
url <- 'https://github.com/liao961120/parallelCode/edit/master/'
gh_edit_path <- paste0(url, knitr::current_input())

edit_btn <- paste0('<a href="', gh_edit_path, '">',
                   '<i class="fa fa-edit" ',
                   'style="font-size: 0.5em;"></i></a>')
```

Remember to include `addons/pre_chap.R` in the `before_chapter_script` field in `_bookdown.yml`.



### Setting up: `_output.yml`

This is the output format I set in `_output.yml`:

```yaml
bookdown::html_document2:
  theme: readable
  highlight: default
  toc: true
  toc_depth: 2
  toc_float:
    collapsed: false
  includes:
    before_body: addons/font_awesome.html
  css: addons/style.css
  self_contained: false
```

Note that in order to use <i class="fa fa-edit"></i>, one has to import the [fontawesome style sheet](https://origin.fontawesome.com/start), since `html_document` doesn't support it.
I put the `<link>` tag that imports fontawesome style sheet in `addons/font_awesome.html` and included it using `before_body: ` under `includes: `

`addons/font_awsome.html`:

```html
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
```


## Path Problems Caused by `self_contained: false`










[^why]: The reason I wanted this feature is that I'm writing a document (actually, a note) that works like a [parallel text](https://en.wikipedia.org/wiki/Parallel_text). 
I know three programming languages -- R, Bash, and Python, but I'm only familiar with R, sometimes struggles with the weird syntax of Bash (that said, I like Bash pretty much, for its power to do quick and dirty works), and not familiar with Python at all.
By creating a [parallel text for R, Bash, and Python](https://liao961120.github.io/parallelCode), I can write down the code to deal with some common tasks in these three langauges, so I don't have to look it up on google every time I forgot the syntax of the langauge.

    I planned to write this document myself initially. But why not do a little more work to make it convenient for others to contribute to this document? This is why I decided to add an "Edit on GitHub" button at the start of every chapter of the document.










